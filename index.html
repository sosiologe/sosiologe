<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Sosiologe</title>
<style>
body{margin:0;font-family:Arial;background:#111;color:#fff}
header{background:#1e1e1e;padding:10px;display:flex;justify-content:space-between}
button,input,textarea{background:#222;color:#fff;border:1px solid #333;padding:8px;border-radius:6px}
.post{background:#1c1c1c;margin:10px;padding:10px;border-radius:8px}
.comment{font-size:14px;color:#ccc;margin-left:10px}
.hidden{display:none}
</style>
</head>
<body>

<header>
<b>Sosiologe</b>
<div id="userBar"></div>
</header>

<div id="auth">
<h3>Вход / Регистрация</h3>
<input id="email" placeholder="email"><br><br>
<input id="password" type="password" placeholder="пароль"><br><br>
<input id="username" placeholder="имя профиля"><br><br>
<button onclick="login()">Войти</button>
<button onclick="register()">Регистрация</button>
</div>

<div id="app" class="hidden">
<h3>Создать пост</h3>
<textarea id="postText"></textarea><br>
<button onclick="addPost()">Опубликовать</button>
<div id="posts"></div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyBMhpCKnZnzWryB5q614gbRUt7qdWL-4wg",
  authDomain: "sosiologe.firebaseapp.com",
  databaseURL: "https://sosiologe-default-rtdb.firebaseio.com",
  projectId: "sosiologe"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();
const ADMIN_UID = "fJj3X9fkrISVtvbSK1Ezf9Njpzz1";

auth.onAuthStateChanged(user=>{
  if(user){
    document.getElementById("auth").classList.add("hidden");
    document.getElementById("app").classList.remove("hidden");
    document.getElementById("userBar").innerHTML =
      user.email + ' <button onclick="logout()">Выйти</button>';
    loadPosts();
  }
});

function register(){
  auth.createUserWithEmailAndPassword(email.value,password.value)
  .then(u=>{
    db.ref("users/"+u.user.uid).set({name:username.value});
  });
}

function login(){
  auth.signInWithEmailAndPassword(email.value,password.value);
}

function logout(){
  auth.signOut();
}

function addPost(){
  const user = auth.currentUser;
  const id = db.ref().child("posts").push().key;
  db.ref("posts/"+id).set({
    text:postText.value,
    uid:user.uid,
    likes:{},
    comments:{}
  });
  postText.value="";
}

function loadPosts(){
  db.ref("posts").on("value",snap=>{
    posts.innerHTML="";
    snap.forEach(p=>{
      const d=p.val();
      const div=document.createElement("div");
      div.className="post";
      div.innerHTML=`
        <b>${d.text}</b><br>
        ❤️ ${d.likes?Object.keys(d.likes).length:0}
        <button onclick="like('${p.key}')">Лайк</button>
        ${auth.currentUser.uid===ADMIN_UID?`<button onclick="del('${p.key}')">❌</button>`:""}
        <br>
        <input placeholder="комментарий" id="c${p.key}">
        <button onclick="comment('${p.key}')">➕</button>
      `;
      if(d.comments){
        Object.values(d.comments).forEach(c=>{
          const cc=document.createElement("div");
          cc.className="comment";
          cc.textContent=c;
          div.appendChild(cc);
        });
      }
      posts.appendChild(div);
    });
  });
}

function like(id){
  const uid=auth.currentUser.uid;
  db.ref(`posts/${id}/likes/${uid}`).set(true);
}

function comment(id){
  const t=document.getElementById("c"+id).value;
  db.ref(`posts/${id}/comments`).push(t);
}

function del(id){
  db.ref("posts/"+id).remove();
}
</script>
</body>
</html>
