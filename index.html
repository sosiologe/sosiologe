<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>sosiologe messenger</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body{margin:0;font-family:Arial;background:#0f172a;color:#fff}
#auth,#app{display:none}
.center{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh}
input,button{padding:10px;margin:5px;border:none;border-radius:6px}
button{background:#2563eb;color:#fff}
#app{display:flex;height:100vh}
#users{width:30%;background:#020617;overflow:auto}
#chat{flex:1;display:flex;flex-direction:column}
.user{padding:10px;border-bottom:1px solid #1e293b;cursor:pointer}
.msgs{flex:1;padding:10px;overflow:auto}
.msg{margin:5px 0}
.me{text-align:right;color:#60a5fa}
.other{color:#facc15}
.top{padding:10px;background:#020617;display:flex;justify-content:space-between}
</style>
</head>
<body>

<div id="auth" class="center">
  <h2>Вход / Регистрация</h2>
  <input id="email" placeholder="email">
  <input id="username" placeholder="username (только при регистрации)">
  <input id="password" type="password" placeholder="пароль">
  <button onclick="login()">Войти</button>
  <button onclick="register()">Регистрация</button>
</div>

<div id="app">
  <div id="users"></div>
  <div id="chat">
    <div class="top">
      <span id="chatWith">Чат</span>
      <button onclick="logout()">Выйти</button>
    </div>
    <div class="msgs" id="msgs"></div>
    <div>
      <input id="msgInput" placeholder="Сообщение">
      <button onclick="sendMsg()">Отправить</button>
    </div>
  </div>
</div>

<!-- Firebase CDN -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyBMhpCKnZnzWryB5q614gbRUt7qdWL-4wg",
  authDomain: "sosiologe.firebaseapp.com",
  databaseURL: "https://sosiologe-default-rtdb.firebaseio.com",
  projectId: "sosiologe",
  storageBucket: "sosiologe.appspot.com",
  messagingSenderId: "651066103994",
  appId: "1:651066103994:web:13f35d4e31bba79c160a83"
};
firebase.initializeApp(firebaseConfig);
const auth=firebase.auth();
const db=firebase.database();

let currentUser=null;
let currentChat=null;

auth.onAuthStateChanged(u=>{
  if(u){
    currentUser=u;
    document.getElementById("auth").style.display="none";
    document.getElementById("app").style.display="flex";
    loadUsers();
  }else{
    document.getElementById("auth").style.display="flex";
    document.getElementById("app").style.display="none";
  }
});

function register(){
  auth.createUserWithEmailAndPassword(
    email.value,password.value
  ).then(res=>{
    db.ref("users/"+res.user.uid).set({
      username:username.value
    });
  });
}

function login(){
  auth.signInWithEmailAndPassword(
    email.value,password.value
  );
}

function logout(){auth.signOut();}

function loadUsers(){
  db.ref("users").on("value",s=>{
    users.innerHTML="";
    s.forEach(u=>{
      if(u.key!==currentUser.uid){
        let d=document.createElement("div");
        d.className="user";
        d.textContent=u.val().username;
        d.onclick=()=>openChat(u.key,u.val().username);
        users.appendChild(d);
      }
    });
  });
}

function openChat(uid,name){
  currentChat=uid;
  chatWith.textContent=name;
  msgs.innerHTML="";
  db.ref("chats/"+chatId()).off();
  db.ref("chats/"+chatId()).on("child_added",m=>{
    let div=document.createElement("div");
    div.className="msg "+(m.val().from===currentUser.uid?"me":"other");
    div.textContent=m.val().text;
    msgs.appendChild(div);
  });
}

function chatId(){
  return [currentUser.uid,currentChat].sort().join("_");
}

function sendMsg(){
  if(!msgInput.value)return;
  db.ref("chats/"+chatId()).push({
    from:currentUser.uid,
    text:msgInput.value
  });
  msgInput.value="";
}
</script>
</body>
</html>
