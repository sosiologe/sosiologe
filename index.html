<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Sosiologe</title>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
body { margin:0; font-family:Arial; background:#111; color:white }
header { padding:10px; background:#1c1c1c; display:flex; justify-content:space-between }
button { background:#3a6df0; color:white; border:none; padding:8px; border-radius:6px }
input, textarea { width:100%; margin:5px 0; padding:8px; border-radius:6px; border:none }
#auth, #app { max-width:500px; margin:auto; padding:15px }
.post { background:#1e1e1e; padding:10px; border-radius:8px; margin-top:10px }
.small { font-size:12px; opacity:.7 }
.admin { background:#ff3b3b }
</style>
</head>

<body>

<header>
  <b>Sosiologe</b>
  <button onclick="logout()">–í—ã–π—Ç–∏</button>
</header>

<div id="auth">
  <h3>–í—Ö–æ–¥ / –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h3>
  <input id="email" placeholder="Email">
  <input id="password" type="password" placeholder="–ü–∞—Ä–æ–ª—å">
  <input id="username" placeholder="–ò–º—è">
  <button onclick="register()">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
  <button onclick="login()">–í—Ö–æ–¥</button>
</div>

<div id="app" style="display:none">
  <h3 id="me"></h3>

  <textarea id="postText" placeholder="–ß—Ç–æ –Ω–æ–≤–æ–≥–æ?"></textarea>
  <button onclick="addPost()">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>

  <div id="posts"></div>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyBMhpCKnZnzWryB5q614gbRUt7qdWL-4wg",
  authDomain: "sosiologe.firebaseapp.com",
  databaseURL: "https://sosiologe-default-rtdb.firebaseio.com",
  projectId: "sosiologe",
  storageBucket: "sosiologe.firebasestorage.app",
  messagingSenderId: "651066103994",
  appId: "1:651066103994:web:13f35d4e31bba79c160a83"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

const ADMIN_UID = "fJj3X9fkrISVtvbSK1Ezf9Njpzz1";

auth.onAuthStateChanged(user=>{
  if(user){
    document.getElementById("auth").style.display="none";
    document.getElementById("app").style.display="block";
    db.ref("users/"+user.uid).once("value").then(s=>{
      document.getElementById("me").innerText = "@" + s.val().name;
    });
    loadPosts();
  }
});

function register(){
  auth.createUserWithEmailAndPassword(
    email.value, password.value
  ).then(cred=>{
    db.ref("users/"+cred.user.uid).set({
      name: username.value
    });
  });
}

function login(){
  auth.signInWithEmailAndPassword(
    email.value, password.value
  );
}

function logout(){ auth.signOut(); }

function addPost(){
  const user = auth.currentUser;
  db.ref("posts").push({
    uid: user.uid,
    text: postText.value,
    time: Date.now(),
    likes:{}
  });
  postText.value="";
}

function loadPosts(){
  db.ref("posts").orderByChild("time").on("value", snap=>{
    posts.innerHTML="";
    snap.forEach(s=>{
      const p = s.val();
      db.ref("users/"+p.uid).once("value").then(u=>{
        const liked = p.likes && p.likes[auth.currentUser.uid];
        posts.innerHTML =
        `<div class="post">
          <b>@${u.val().name}</b>
          <div>${p.text}</div>
          <div class="small">
            <button onclick="like('${s.key}')">${liked?"‚ù§Ô∏è":"ü§ç"} ${p.likes?Object.keys(p.likes).length:0}</button>
            ${auth.currentUser.uid===ADMIN_UID?`<button class="admin" onclick="del('${s.key}')">–£–¥–∞–ª–∏—Ç—å</button>`:""}
          </div>
        </div>` + posts.innerHTML;
      });
    });
  });
}

function like(id){
  const uid = auth.currentUser.uid;
  db.ref("posts/"+id+"/likes/"+uid).set(true);
}

function del(id){
  db.ref("posts/"+id).remove();
}
</script>

</body>
</html>
