<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Sosiologe</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body { margin:0; font-family:system-ui; background:#0f172a; color:white }
.hidden { display:none }
.container { max-width:600px; margin:auto; padding:16px }
.card { background:#111827; border-radius:12px; padding:16px; margin-bottom:12px }
input, button, textarea {
  width:100%; padding:10px; margin-top:8px;
  border-radius:8px; border:none;
}
button { background:#22c55e; font-weight:600 }
.red { background:#ef4444; color:white }
.post { border-top:1px solid #1f2937; padding-top:10px; margin-top:10px }
.small { font-size:12px; opacity:.6 }
.avatar { width:40px; height:40px; border-radius:50%; object-fit:cover }
.row { display:flex; gap:10px; align-items:center }
.like { cursor:pointer }
</style>
</head>

<body>

<div class="container">

<!-- AUTH -->
<div id="auth" class="card">
  <h2>–í—Ö–æ–¥</h2>
  <input id="email" placeholder="Email">
  <input id="password" type="password" placeholder="–ü–∞—Ä–æ–ª—å">
  <input id="nameReg" placeholder="–ò–º—è (–¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏)">
  <button onclick="login()">–í–æ–π—Ç–∏</button>
  <button onclick="register()">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
  <div id="authError" class="small"></div>
</div>

<!-- APP -->
<div id="app" class="hidden">

<!-- PROFILE -->
<div class="card">
  <div class="row">
    <img id="avatarImg" class="avatar">
    <div>
      <b id="username"></b><br>
      <span class="small" id="uid"></span>
    </div>
  </div>
  <input id="avatar" placeholder="URL –∞–≤–∞—Ç–∞—Ä–∫–∏">
  <button onclick="saveProfile()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</button>
  <button class="red" onclick="logout()">–í—ã–π—Ç–∏</button>
</div>

<!-- NEW POST -->
<div class="card">
  <textarea id="postText" placeholder="–ß—Ç–æ –Ω–æ–≤–æ–≥–æ?"></textarea>
  <button onclick="addPost()">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
</div>

<!-- FEED -->
<div class="card">
  <h3>–õ–µ–Ω—Ç–∞</h3>
  <div id="feed"></div>
</div>

</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import {
  getAuth, createUserWithEmailAndPassword,
  signInWithEmailAndPassword, onAuthStateChanged, signOut
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import {
  getDatabase, ref, set, push, onValue, update, get
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

const ADMIN_UID = "fJj3X9fkrISVtvbSK1Ezf9Njpzz1";

const firebaseConfig = {
  apiKey: "AIzaSyBMhpCKnZnzWryB5q614gbRUt7qdWL-4wg",
  authDomain: "sosiologe.firebaseapp.com",
  databaseURL: "https://sosiologe-default-rtdb.firebaseio.com",
  projectId: "sosiologe",
  storageBucket: "sosiologe.firebasestorage.app",
  messagingSenderId: "651066103994",
  appId: "1:651066103994:web:13f35d4e31bba79c160a83"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

const authBox = document.getElementById("auth");
const appBox = document.getElementById("app");

window.register = () => {
  createUserWithEmailAndPassword(auth, email.value, password.value)
    .then(r => {
      set(ref(db, "users/" + r.user.uid), {
        name: nameReg.value || "–ë–µ–∑ –∏–º–µ–Ω–∏",
        avatar: "https://i.imgur.com/8Km9tLL.png"
      });
    })
    .catch(e => authError.textContent = e.message);
};

window.login = () => {
  signInWithEmailAndPassword(auth, email.value, password.value)
    .catch(e => authError.textContent = e.message);
};

window.logout = () => signOut(auth);

window.saveProfile = () => {
  const u = auth.currentUser;
  update(ref(db, "users/" + u.uid), {
    avatar: avatar.value
  });
};

window.addPost = () => {
  const u = auth.currentUser;
  push(ref(db, "posts"), {
    uid: u.uid,
    text: postText.value,
    time: Date.now(),
    likes: {}
  });
  postText.value = "";
};

onAuthStateChanged(auth, user => {
  if (!user) {
    authBox.classList.remove("hidden");
    appBox.classList.add("hidden");
    return;
  }

  authBox.classList.add("hidden");
  appBox.classList.remove("hidden");

  uid.textContent = user.uid;

  get(ref(db, "users/" + user.uid)).then(s => {
    const d = s.val();
    username.textContent = d.name;
    avatarImg.src = d.avatar;
  });

  onValue(ref(db, "posts"), snap => {
    feed.innerHTML = "";
    snap.forEach(p => {
      const post = p.val();
      const liked = post.likes && post.likes[user.uid];
      feed.innerHTML += `
        <div class="post">
          <div>${post.text}</div>
          <div class="small">
            <span class="like" onclick="toggleLike('${p.key}')">
              ‚ù§Ô∏è ${post.likes ? Object.keys(post.likes).length : 0}
            </span>
            ${user.uid === ADMIN_UID ? `<button onclick="delPost('${p.key}')">üóë</button>` : ""}
          </div>
        </div>`;
    });
  });
});

window.toggleLike = id => {
  const u = auth.currentUser;
  const likeRef = ref(db, "posts/" + id + "/likes/" + u.uid);
  get(likeRef).then(s => {
    if (s.exists()) set(likeRef, null);
    else set(likeRef, true);
  });
};

window.delPost = id => {
  set(ref(db, "posts/" + id), null);
};
</script>

</body>
</html>
