<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SOSIOLOGE — Ultimate Terminal</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;800;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #0b0e11; --card-bg: #161a1e; --input-bg: #1e2329;
            --primary-color: #3b82f6; --text-main: #ffffff; --text-muted: #848e9c;
            --border-color: #2b3139; --success-color: #02c076; --danger-color: #d93025;
            --gradient-1: #0b0e11; --gradient-2: #1c2127; --gradient-3: #080a0c;
            --status-color: #02c076;
        }
        body.light-mode {
            --bg-color: #f0f2f5; --card-bg: #ffffff; --input-bg: #f5f5f5;
            --text-main: #1e2329; --text-muted: #707a8a; --border-color: #eaecef;
            --primary-color: #2563eb; --gradient-1: #f0f2f5; --gradient-2: #e1e5ea; --gradient-3: #ffffff;
        }
        body { background-color: var(--bg-color); color: var(--text-main); font-family: 'Inter', sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; min-height: 100vh; margin: 0; padding: 100px 0 40px 0; overflow-x: hidden; position: relative; transition: background 0.5s ease; font-weight: 700; }
        
        .bg-gradient { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -2; background: linear-gradient(45deg, var(--gradient-1), var(--gradient-2), var(--gradient-3)); background-size: 400% 400%; animation: gradientShift 10s ease infinite; }
        @keyframes gradientShift { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        #snow-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; pointer-events: none; }

        .live-status { position: absolute; top: 30px; left: 30px; display: flex; align-items: center; gap: 10px; background: var(--input-bg); padding: 8px 14px; border-radius: 12px; border: 1px solid var(--border-color); z-index: 10; }
        .dot { width: 8px; height: 8px; background-color: var(--status-color); border-radius: 50%; position: relative; }
        .dot::after { content: ''; position: absolute; width: 100%; height: 100%; background-color: inherit; border-radius: 50%; animation: pulse 2s infinite; top:0; left:0; }
        @keyframes pulse { 0% { transform: scale(1); opacity: 1; } 100% { transform: scale(2.5); opacity: 0; } }
        .live-text { font-size: 11px; font-weight: 900; text-transform: uppercase; letter-spacing: 0.5px; }

        .theme-toggle-btn { position: absolute; top: 30px; right: 30px; background: var(--input-bg); border: 1px solid var(--border-color); border-radius: 12px; cursor: pointer; width: 44px; height: 44px; display: flex; align-items: center; justify-content: center; z-index: 100; }
        .icon-sun, .icon-moon { position: absolute; width: 24px; height: 24px; transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1); }
        .icon-sun { color: #f1c40f; opacity: 1; } .icon-moon { color: #848e9c; opacity: 0; transform: scale(0); }
        body.light-mode .icon-sun { opacity: 0; transform: scale(0); } body.light-mode .icon-moon { opacity: 1; transform: scale(1); }

        .app-container { width: 90%; max-width: 400px; background: var(--card-bg); border: 2px solid var(--border-color); border-radius: 32px; padding: 30px; box-shadow: 0 20px 50px rgba(0,0,0,0.3); backdrop-filter: blur(10px); margin-bottom: 25px; }
        header { text-align: center; margin-bottom: 25px; }
        .logo { font-size: 38px; font-weight: 900; text-transform: uppercase; letter-spacing: -2px; margin: 0; background: linear-gradient(180deg, var(--text-muted) 0%, #4a5568 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; opacity: 0.85; }

        .warning-banner { background: var(--danger-color); color: white; padding: 12px; border-radius: 14px; font-size: 12px; text-align: center; margin: 15px 0; font-weight: 900; text-transform: uppercase; display: none; }
        
        .currency-select-container { display: flex; align-items: center; gap: 10px; background: var(--input-bg); padding: 5px 10px; border-radius: 12px; }
        .coin-icon { width: 24px; height: 24px; border-radius: 50%; object-fit: contain; }

        .input-card { background: var(--input-bg); border: 1px solid var(--border-color); border-radius: 20px; padding: 20px; transition: 0.3s; position: relative; }
        .input-card label { display: block; font-size: 11px; color: var(--text-muted); font-weight: 900; text-transform: uppercase; margin-bottom: 8px; letter-spacing: 0.5px; }
        select { background: none; border: none; color: var(--text-main); font-size: 16px; font-weight: 900; outline: none; cursor: pointer; }
        input { background: none; border: none; color: var(--text-main); font-size: 26px; font-weight: 800; text-align: right; width: 100%; outline: none; }

        .swap-divider { display: flex; justify-content: center; height: 16px; position: relative; z-index: 5; }
        .swap-btn { background: var(--primary-color); border: 5px solid var(--card-bg); width: 48px; height: 48px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; position: absolute; top: -16px; transition: 0.5s; color: white; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3); }
        .swap-btn svg { width: 22px; height: 22px; }

        .history-container { width: 90%; max-width: 400px; background: var(--card-bg); border-radius: 24px; padding: 20px; border: 1px solid var(--border-color); margin-bottom: 25px; }
        .history-item { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid var(--border-color); font-size: 14px; font-weight: 800; }
        
        .market-overview { width: 90%; max-width: 400px; background: var(--input-bg); border-radius: 20px; padding: 15px 20px; border: 1px solid var(--border-color); display: flex; flex-direction: column; gap: 10px; }
        .market-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .market-item { display: flex; justify-content: space-between; font-size: 13px; font-weight: 800; }

        .update-tag { font-size: 10px; color: var(--text-muted); text-align: center; margin-top: 10px; font-weight: 800; text-transform: uppercase; }
    </style>
</head>
<body>
    <div class="bg-gradient"></div>
    <canvas id="snow-canvas"></canvas>
    <div class="live-status"><div class="dot" id="status-dot"></div><span id="status-label" class="live-text">ONLINE</span></div>
    
    <button class="theme-toggle-btn" id="theme-toggle">
        <svg class="icon-sun" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="4"></circle><path d="M12 2v2M12 20v2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M2 12h2M20 12h2M6.34 17.66l-1.41 1.41M19.07 4.93l-1.41 1.41"></path></svg>
        <svg class="icon-moon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"></path></svg>
    </button>

    <div class="app-container">
        <header><p class="logo">SOSIOLOGE</p></header>
        <div class="warning-banner" id="banner-text"></div>
        
        <div class="input-card">
            <label>You pay</label>
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div class="currency-select-container">
                    <img id="img-c1" class="coin-icon" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=">
                    <select id="c1">
                        <option value="RUB">RUB</option><option value="USD">USD</option><option value="EUR">EUR</option>
                        <option value="GBP">GBP</option><option value="TRY">TRY</option><option value="KZT">KZT</option><option value="UAH">UAH</option>
                        <option value="BTC">BTC</option><option value="ETH">ETH</option><option value="USDT">USDT</option>
                        <option value="TON">TON</option><option value="SOL">SOL</option><option value="BNB">BNB</option>
                        <option value="XRP">XRP</option><option value="DOGE">DOGE</option><option value="ADA">ADA</option>
                        <option value="TRX">TRX</option><option value="DOT">DOT</option><option value="LTC">LTC</option><option value="MATIC">MATIC</option>
                    </select>
                </div>
                <input type="number" id="a1" value="100">
            </div>
        </div>
        
        <div class="swap-divider">
            <button class="swap-btn" id="swap">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M7 16V4M7 4L3 8M7 4L11 8M17 8V20M17 20L21 16M17 20L13 16"></path></svg>
            </button>
        </div>

        <div class="input-card" onclick="copyResult()" style="cursor:pointer; margin-top: 5px;">
            <label id="receive-label">You receive</label>
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div class="currency-select-container">
                    <img id="img-c2" class="coin-icon" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=">
                    <select id="c2">
                        <option value="RUB">RUB</option><option value="USD" selected>USD</option><option value="EUR">EUR</option>
                        <option value="GBP">GBP</option><option value="TRY">TRY</option><option value="KZT">KZT</option><option value="UAH">UAH</option>
                        <option value="BTC">BTC</option><option value="ETH">ETH</option><option value="USDT">USDT</option>
                        <option value="TON">TON</option><option value="SOL">SOL</option><option value="BNB">BNB</option>
                        <option value="XRP">XRP</option><option value="DOGE">DOGE</option><option value="ADA">ADA</option>
                        <option value="TRX">TRX</option><option value="DOT">DOT</option><option value="LTC">LTC</option><option value="MATIC">MATIC</option>
                    </select>
                </div>
                <input type="text" id="a2" readonly placeholder="0.00" style="cursor:pointer">
            </div>
        </div>
        <div class="update-tag">Refresh in: <span id="refresh-time">60</span>s</div>
    </div>

    <div class="history-container">
        <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
            <span style="font-size:12px; color:var(--text-muted); text-transform:uppercase;">Trades history</span>
            <button id="clear-history" style="background:none; border:none; color:#ff4444; cursor:pointer; font-weight:900;">Clear</button>
        </div>
        <div id="history-list"></div>
    </div>

    <div class="market-overview">
        <div class="market-grid">
            <div class="market-item"><span>BTC</span><span id="p-BTC">...</span></div>
            <div class="market-item"><span>ETH</span><span id="p-ETH">...</span></div>
            <div class="market-item"><span>TON</span><span id="p-TON">...</span></div>
            <div class="market-item"><span>SOL</span><span id="p-SOL">...</span></div>
        </div>
    </div>

    <script>
        const BIN_ID = '69511455d0ea881f40451e66', 
              API_KEY = '$2a$10$DsTYqR4FUAVU/LrGU/xIHupctFvvUPF5LiiWhrdgLCxkPdayOm/AC';
        
        let history = JSON.parse(localStorage.getItem('trade_history') || '[]'), 
            refreshTimer = 60, isFirstLoad = true, isCalcEnabled = true;

        function getIconUrl(symbol) {
            const crypto = ['BTC','ETH','USDT','BNB','SOL','XRP','ADA','DOGE','TRX','MATIC','LTC','DOT','TON'];
            if (crypto.includes(symbol)) {
                return `https://www.cryptocompare.com/media/20275/${symbol.toLowerCase()}.png?width=50`;
            }
            const fiat = {
                'RUB':'russian-ruble', 'USD':'usa-currency', 'EUR':'euro-currency',
                'GBP':'british-pounds', 'TRY':'turkish-lira', 'KZT':'kazakhstan-tenge', 'UAH':'hryvnia'
            };
            return `https://img.icons8.com/color/48/${fiat[symbol] || 'currency'}.png`;
        }

        const tonIcon = "https://cryptologos.cc/logos/toncoin-ton-logo.png";

        async function loadRemoteConfig() {
            try {
                const res = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}/latest`, { headers: { 'X-Master-Key': API_KEY } });
                const config = (await res.json()).record;
                const banner = document.getElementById('banner-text');
                if(config.text && config.text.trim() !== "") {
                    banner.innerText = config.text; banner.style.display = 'block';
                    if(config.banner_color) banner.style.backgroundColor = config.banner_color;
                } else { banner.style.display = 'none'; }
                if(config.status_text) document.getElementById('status-label').innerText = config.status_text;
                isCalcEnabled = config.calc_enabled !== false;
                document.getElementById('status-dot').style.backgroundColor = isCalcEnabled ? "var(--success-color)" : "#ff4444";
                if(!isCalcEnabled) document.getElementById('a2').value = "OFFLINE";
                else if(!isFirstLoad) calc(true);
            } catch(e) {}
        }

        function updateIcons() {
            const s1 = document.getElementById('c1').value;
            const s2 = document.getElementById('c2').value;
            const i1 = document.getElementById('img-c1');
            const i2 = document.getElementById('img-c2');
            
            i1.src = s1 === 'TON' ? tonIcon : getIconUrl(s1);
            i2.src = s2 === 'TON' ? tonIcon : getIconUrl(s2);

            // Сохраняем выбор в localStorage
            localStorage.setItem('last_c1', s1);
            localStorage.setItem('last_c2', s2);

            i1.onerror = () => { i1.src = 'https://img.icons8.com/color/48/generic-sorting-database.png'; };
            i2.onerror = () => { i2.src = 'https://img.icons8.com/color/48/generic-sorting-database.png'; };
        }

        async function calc(skipHistory = false) {
            updateIcons();
            if(!isCalcEnabled) return;
            const from = document.getElementById('c1').value, to = document.getElementById('c2').value, amt = parseFloat(document.getElementById('a1').value);
            if(!amt || amt <= 0) { document.getElementById('a2').value = "0.00"; return; }
            try {
                const res = await fetch(`https://min-api.cryptocompare.com/data/price?fsym=${from}&tsyms=${to}`);
                const data = await res.json();
                if(data && data[to]) {
                    const resVal = (amt * data[to]).toFixed(to === 'BTC' || to === 'ETH' || to === 'SOL' ? 6 : 2);
                    document.getElementById('a2').value = resVal;
                    if(!skipHistory && !isFirstLoad) {
                        history.unshift({f: from, t: to, a: resVal});
                        if(history.length > 5) history.pop();
                        renderHistory();
                    }
                }
            } catch(e) {}
        }

        // Тема
        if (localStorage.getItem('theme') === 'light') document.body.classList.add('light-mode');
        document.getElementById('theme-toggle').onclick = () => { 
            document.body.classList.toggle('light-mode'); 
            localStorage.setItem('theme', document.body.classList.contains('light-mode') ? 'light' : 'dark'); 
        };

        function renderHistory() {
            const list = document.getElementById('history-list');
            list.innerHTML = history.length ? history.map((i, idx) => `
                <div class="history-item"><span>${i.f} → ${i.t}</span><span>${i.a} <button onclick="del(${idx})" style="color:#ff4444;background:none;border:none;cursor:pointer">✕</button></span></div>`).join('') : '<div style="text-align:center;font-size:12px;color:var(--text-muted)">No history</div>';
            localStorage.setItem('trade_history', JSON.stringify(history));
        }
        window.del = (i) => { history.splice(i,1); renderHistory(); };
        document.getElementById('clear-history').onclick = () => { history = []; renderHistory(); };

        document.getElementById('swap').onclick = function() {
            if(!isCalcEnabled) return;
            const c1 = document.getElementById('c1'), c2 = document.getElementById('c2');
            const v = c1.value; c1.value = c2.value; c2.value = v;
            calc();
        };

        // Снег
        const canvas = document.getElementById('snow-canvas'), ctx = canvas.getContext('2d');
        let parts = [];
        function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
        window.onresize = resize; resize();
        for(let i=0; i<50; i++) parts.push({x: Math.random()*canvas.width, y: Math.random()*canvas.height, s: Math.random()*2+1, d: Math.random()*0.5+0.5});
        function draw() {
            ctx.clearRect(0,0,canvas.width,canvas.height);
            ctx.fillStyle = document.body.classList.contains('light-mode') ? 'rgba(0,0,0,0.1)' : 'rgba(255,255,255,0.4)';
            parts.forEach(p => { ctx.beginPath(); ctx.arc(p.x, p.y, p.s, 0, Math.PI*2); ctx.fill(); p.y += p.d; if(p.y > canvas.height) p.y = -5; });
            requestAnimationFrame(draw);
        }
        draw();

        async function updateMarket() {
            try {
                const res = await fetch('https://min-api.cryptocompare.com/data/price?fsym=USD&tsyms=BTC,ETH,TON,SOL');
                const data = await res.json();
                for(let c in data) if(data[c]) document.getElementById('p-'+c).innerText = '$' + (1/data[c]).toLocaleString(undefined, {minimumFractionDigits: 2});
            } catch(e) {}
        }

        function copyResult() {
            const val = document.getElementById('a2').value;
            if(val && val !== "0.00" && val !== "OFFLINE") {
                navigator.clipboard.writeText(val);
                const l = document.getElementById('receive-label');
                l.innerText = "COPIED!"; l.style.color = "var(--success-color)";
                setTimeout(() => { l.innerText = "YOU RECEIVE"; l.style.color = ""; }, 1500);
            }
        }

        document.getElementById('a1').oninput = () => calc();
        document.getElementById('c1').onchange = () => calc();
        document.getElementById('c2').onchange = () => calc();

        // Запуск
        (async () => { 
            // 1. Сначала восстанавливаем валюты из памяти
            const s1 = localStorage.getItem('last_c1'), s2 = localStorage.getItem('last_c2');
            if(s1) document.getElementById('c1').value = s1;
            if(s2) document.getElementById('c2').value = s2;

            // 2. Затем грузим конфиг и рынок
            await loadRemoteConfig(); 
            updateMarket(); 
            renderHistory(); 
            updateIcons();
            await calc(true); 
            isFirstLoad = false; 
        })();

        setInterval(() => { 
            refreshTimer--; 
            if(refreshTimer <= 0) { 
                calc(true); 
                updateMarket(); 
                loadRemoteConfig(); 
                refreshTimer=60; 
            } 
            document.getElementById('refresh-time').innerText = refreshTimer; 
        }, 1000);
    </script>
</body>
</html>
