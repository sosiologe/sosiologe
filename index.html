<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Sosiologe</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body{margin:0;font-family:Arial;background:#f2f2f2}
header{background:#111;color:#fff;padding:10px;display:flex;justify-content:space-between}
button{padding:6px 10px;margin:5px}
#auth,#app{max-width:600px;margin:auto;padding:10px}
.post{background:#fff;margin:10px 0;padding:10px;border-radius:6px}
.post img{max-width:100%;border-radius:6px}
.comment{font-size:14px;margin-left:10px}
.avatar{width:40px;height:40px;border-radius:50%;object-fit:cover}
</style>
</head>
<body>

<header>
  <div>Sosiologe</div>
  <button onclick="logout()">Выйти</button>
</header>

<div id="auth">
  <h3>Вход / Регистрация</h3>
  <input id="email" placeholder="Email"><br>
  <input id="password" type="password" placeholder="Пароль"><br>
  <input id="name" placeholder="Имя"><br>
  <button onclick="register()">Регистрация</button>
  <button onclick="login()">Вход</button>
</div>

<div id="app" style="display:none">
  <h3>Создать пост</h3>
  <input id="postText" placeholder="Текст"><br>
  <input id="postImg" placeholder="Ссылка на картинку"><br>
  <button onclick="addPost()">Опубликовать</button>

  <div id="posts"></div>
</div>

<script type="module">
import {initializeApp} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {getAuth,createUserWithEmailAndPassword,signInWithEmailAndPassword,onAuthStateChanged,signOut} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import {getDatabase,ref,set,push,onValue,update} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBMhpCKnZnzWryB5q614gbRUt7qdWL-4wg",
  authDomain: "sosiologe.firebaseapp.com",
  databaseURL: "https://sosiologe-default-rtdb.firebaseio.com",
  projectId: "sosiologe",
  storageBucket: "sosiologe.appspot.com",
  messagingSenderId: "651066103994",
  appId: "1:651066103994:web:13f35d4e31bba79c160a83"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth();
const db = getDatabase();

window.register = ()=>{
  createUserWithEmailAndPassword(auth,email.value,password.value)
  .then(r=>{
    set(ref(db,"users/"+r.user.uid),{name:name.value});
  });
}

window.login = ()=>{
  signInWithEmailAndPassword(auth,email.value,password.value);
}

window.logout = ()=>signOut(auth);

onAuthStateChanged(auth,u=>{
  if(u){
    authDiv.style.display="none";
    appDiv.style.display="block";
    loadPosts();
  }else{
    authDiv.style.display="block";
    appDiv.style.display="none";
  }
});

const authDiv=document.getElementById("auth");
const appDiv=document.getElementById("app");

window.addPost=()=>{
  const p=push(ref(db,"posts"));
  set(p,{
    text:postText.value,
    img:postImg.value,
    uid:auth.currentUser.uid,
    likes:{}
  });
}

function loadPosts(){
  onValue(ref(db,"posts"),s=>{
    posts.innerHTML="";
    s.forEach(p=>{
      const d=p.val();
      const liked=d.likes&&d.likes[auth.currentUser.uid];
      posts.innerHTML+=`
      <div class="post">
        <p>${d.text}</p>
        ${d.img?`<img src="${d.img}">`:""}
        <button onclick="like('${p.key}')">
          ❤️ ${d.likes?Object.keys(d.likes).length:0}
        </button>
      </div>`;
    });
  });
}

window.like=id=>{
  const r=ref(db,"posts/"+id+"/likes/"+auth.currentUser.uid);
  set(r,true);
}
</script>
</body>
</html>
