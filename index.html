<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Sosiologe</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <style>
    body { margin:0;font-family:sans-serif;background:#0f172a;color:#fff }
    header { display:flex;justify-content:space-between;align-items:center;padding:10px;background:#020617 }
    button { padding:8px 12px;border:none;border-radius:6px;background:#38bdf8;color:#000 }
    input,textarea { width:100%;margin:5px 0;padding:8px;border-radius:6px;border:none }
    .container { padding:15px;max-width:600px;margin:auto }
    .post { background:#020617;padding:10px;margin:10px 0;border-radius:8px }
    .hidden { display:none }
    img { max-width:100%;border-radius:6px }
  </style>
</head>
<body>

<header>
  <b>sosiologe</b>
  <button id="logoutBtn" class="hidden">–í—ã–π—Ç–∏</button>
</header>

<div class="container">

  <!-- AUTH -->
  <div id="auth">
    <h3>–í—Ö–æ–¥ / –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h3>
    <input id="email" placeholder="Email">
    <input id="password" type="password" placeholder="–ü–∞—Ä–æ–ª—å">
    <input id="username" placeholder="–ò–º—è –ø—Ä–æ—Ñ–∏–ª—è">
    <button onclick="register()">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
    <button onclick="login()">–í—Ö–æ–¥</button>
  </div>

  <!-- APP -->
  <div id="app" class="hidden">
    <h3 id="profileName"></h3>

    <h4>–ù–æ–≤—ã–π –ø–æ—Å—Ç</h4>
    <textarea id="postText" placeholder="–ß—Ç–æ –Ω–æ–≤–æ–≥–æ?"></textarea>
    <input id="postImage" placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫—É (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)">
    <button onclick="createPost()">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>

    <h4>–õ–µ–Ω—Ç–∞</h4>
    <div id="posts"></div>
  </div>

</div>

<script>
  // üî• –¢–í–û–ô –ö–û–ù–§–ò–ì ‚Äî –û–ù –£–ñ–ï –ü–†–ê–í–ò–õ–¨–ù–´–ô
  const firebaseConfig = {
    apiKey: "AIzaSyBMhpCKnZnzWryB5q614gbRUt7qdWL-4wg",
    authDomain: "sosiologe.firebaseapp.com",
    databaseURL: "https://sosiologe-default-rtdb.firebaseio.com",
    projectId: "sosiologe",
    storageBucket: "sosiologe.firebasestorage.app",
    messagingSenderId: "651066103994",
    appId: "1:651066103994:web:13f35d4e31bba79c160a83"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();

  const authDiv = document.getElementById('auth');
  const appDiv = document.getElementById('app');
  const profileName = document.getElementById('profileName');
  const postsDiv = document.getElementById('posts');
  const logoutBtn = document.getElementById('logoutBtn');

  auth.onAuthStateChanged(user => {
    if (user) {
      authDiv.classList.add('hidden');
      appDiv.classList.remove('hidden');
      logoutBtn.classList.remove('hidden');

      db.ref('users/' + user.uid).once('value').then(snap => {
        profileName.innerText = snap.val().name;
      });

      loadPosts();
    } else {
      authDiv.classList.remove('hidden');
      appDiv.classList.add('hidden');
      logoutBtn.classList.add('hidden');
    }
  });

  function register() {
    const email = email.value;
    const password = document.getElementById('password').value;
    const name = document.getElementById('username').value;

    auth.createUserWithEmailAndPassword(email, password)
      .then(cred => {
        db.ref('users/' + cred.user.uid).set({ name });
      })
      .catch(e => alert(e.message));
  }

  function login() {
    auth.signInWithEmailAndPassword(
      email.value,
      document.getElementById('password').value
    ).catch(e => alert(e.message));
  }

  logoutBtn.onclick = () => auth.signOut();

  function createPost() {
    const user = auth.currentUser;
    const text = postText.value;
    const img = postImage.value;

    if (!text) return;

    const postRef = db.ref('posts').push();
    postRef.set({
      uid: user.uid,
      text,
      img,
      time: Date.now()
    });

    postText.value = '';
    postImage.value = '';
  }

  function loadPosts() {
    db.ref('posts').on('value', snap => {
      postsDiv.innerHTML = '';
      snap.forEach(p => {
        const post = p.val();
        const div = document.createElement('div');
        div.className = 'post';
        div.innerHTML = `
          <p>${post.text}</p>
          ${post.img ? `<img src="${post.img}">` : ''}
        `;
        postsDiv.prepend(div);
      });
    });
  }
</script>

</body>
</html>
